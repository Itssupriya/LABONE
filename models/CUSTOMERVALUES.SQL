
with stg_customers as (selectid as customer_id, first_name, last_namefrom lab_one.customers),stg_orders as (selectid as order_id,user_id as customer_id, order_date, statusfrom lab_one.orders),stg_payments as (select id as payment_id, order_id, payment_method, amount / 100 as amountfrom lab_one.Payments),customer_orders as (select customer_id, min(order_date) as first_order,max(order_date) as most_recent_order,count(order_id) as number_of_ordersfrom stg_ordersgroup by customer_id),customer_payments as (select stg_orders.customer_id, sum(amount) as total_amountfrom stg_paymentsleft join stg_orders on stg_payments.order_id = Stg_orders.order_idgroup by stg_orders.customer_id),final as (selectstg_customers.customer_id,stg_customers.first_name,stg_customers.last_name,customer_orders.first_order,customer_orders.most_recent_order,customer_orders.number_of_orders,customer_payments.total_amount as customer_lifetime_valuefrom stg_customersleft join customer_orderson stg_customers.customer_id = customer_orders.customer_idleft join customer_paymentson stg_customers.customer_id = customer_payments.customer_id

